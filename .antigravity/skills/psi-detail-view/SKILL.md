---
name: PSI 詳細預測視圖 (PSI Detail View)
description: PSI 詳細頁面 (psi_detail.html) 的顯示標準與邏輯。
---

# PSI 詳細預測視圖技能 (PSI Detail View Skill)

此技能定義了 PSI (預測到貨、預測銷售、庫存) 詳細頁面的複雜視覺風格與邏輯。

## 1. UI 結構
-   **上月實績顯示邏輯 (Previous Month Actuals Logic)**:
    -   **判斷狀態 (State Detection)**:
        1.  **新產品/初始狀態 (Initial State)**: 若上月 `actual_p`、`actual_s` 與 `forecast_p`、`forecast_s`、`forecast_i` 皆為 0。
        2.  **一般狀態 (Normal State)**: 若不符合上述條件。

    -   **新產品/初始狀態 UI**:
        -   **內容**: 僅顯示並允許編輯「初始庫存」(`actual_i`)。
        -   **佈局**: 靠右顯示。
        -   **互動**: 點擊此區塊開啟編輯彈窗設定 I。

    -   **一般狀態 UI**:
        -   **內容分佈**:
            - **左側區塊**: 雙排顯示。
                - 第一排：上月預測值 (Forecast P/S/I)，灰色系文字。
                - 第二排：上月實際值 (Actual P/S/I)，主色系文字。
            - **右側區塊**: 大文字框顯示「初始庫存」(`actual_i`)。
                - **樣式**: 高亮顯示 (Highlight)，不可直接編輯。
                - **互動**: 點擊此區塊開啟編輯彈窗，允許填寫/修正 `actual_p` 與 `actual_s` 與 `actual_i`

    -   **首次編輯邏輯**:
        -   若進入「一般狀態」且為該月份**第一次**編輯：
            - 自動將「上月預測值 (Forecast)」複製到「實際上月值 (Actual)」。
            - 立即觸發 6 個月 Rolling Calculation（滾動計算）。
            - 同步儲存至資料庫。

-   **PSI 網格 (Grid)**:
    -   **佈局**: 使用 CSS Grid，優先讓 6 個月視圖適應螢幕，不足時啟用水平滾動。
    -   **行項目**:
        1.  **標題行**: 月份名稱 (例如 "2026 年 1 月")。
        2.  **預測到貨 (Forecast P)**: 文字顏色：綠色 (#4CAF50)。
        3.  **預測銷售 (Forecast S)**: 文字顏色：紅色 (#F44336)。
        4.  **庫存預測 (Forecast I)**: 文字顏色：黑色 (#000000)，加粗。
    -   **編輯互動**: 僅未來月份（當月及之後）的P/S儲存格可點擊編輯。

## 2. 互動邏輯
-   **上月實績編輯**:
    -   **觸發**: 點擊上月實績的實際值區域。
    -   **連動計算**: 儲存後，立即觸發「期初庫存」重算，並連動更新下方所有預測月份的庫存 (Rolling Calc)。

-   **預測編輯**:
    -   **觸發**: 點擊預測月份（當月及未來）的 P/S 儲存格。
    -   **彈出視窗內容**:
        -   標題：預測編輯 - [月份名稱]。
        -   輸入欄位：預測到貨 (P)、預測銷售 (S)。
        -   **驗證**: 輸入時立即計算該月及後續月份庫存，若任何月份庫存計算結果為負或輸入負數，顯示錯誤並禁用儲存按鈕。
        -   動作：儲存、取消。

-   **滾動計算規則**:
    -   修改上月實際值 → 重新計算所有月份預測庫存。
    -   修改某月預測P/S → 重新計算該月及之後所有月份預測庫存。
    -   計算順序: 從最早月份向後逐月計算。
    -   計算公式: `當月I = 前月I + 當月P - 當月S`。

## 3. 數據邏輯 (PSI 核心)
-   **期初庫存來源**: `上月實際I` (若無則往前推算或設為 0)。
-   **期初庫存來源規則（補充）**：
    1. 若存在上月實際 I → 直接採用。
-   **上月實際I計算**: `上上月實際I + 上月實際P - 上月實際S`。
-   **預測庫存公式**: `當月庫存 (I) = 前月庫存 + 當月預測到貨 (P) - 當月預測銷售 (S)`。
-   **響應式計算**:
    -   **即時回饋**: 修改「上月實際值」或任何月份的 P/S 時，必須 **立即** 在前端 DOM 中重新計算該月份及其後所有月份的庫存 (I)。
    -   **無需等待**: 不要等待後端回應才更新 UI 數值，應先在前端完成計算並更新顯示。
    -   **驗證先行**: 所有計算必須通過驗證（數值≥0，庫存≥0）才能允許儲存。
-   **資料來源**: 
    -   **讀取**: 進入詳細頁面時，**不應** 再次呼叫 API 讀取資料。
    -   必須使用 App 初始化時載入的 **全域快取資料 (Global State)**。
    -   僅在使用者執行「重新整理」動作時才重新 Fetch。
-   **數據範圍**: 6 個月 (當月 + 未來 5 個月)。

## 4. 視覺化
-   **圖表**: 在網格下方使用 Canvas (Chart.js) 顯示 P、S、I 的趨勢圖。
-   **圖表數據範圍**: 包含 **上個月實際值** 與 **6個月預測值**，共7個數據點。
-   **特殊標記**: 在圖表上，上個月的實際P、S、I值需以 **實心圓點** 標記，與預測線條的樣式區分。

## 5. 語言規範
-   嚴格遵守 `localization-rules` 技能。
-   標準標籤："預測到貨 (P)", "預測銷售 (S)", "庫存預測 (I)"。

## 6. 資料儲存規範 (Persistence Logic)
- **儲存範圍**: 呼叫儲存 API 時，必須包含：
    1.  **上個月資料 (Context)**: 包含 `actual_p`, `actual_s`, `actual_i`，以及原預測值 `forecast_p`, `forecast_s`, `forecast_i`（用於記錄與比較）。
    2.  **未來 6 個月預測**: 包含 `forecast_p`, `forecast_s`, `forecast_i` (預測)。
- **批次儲存**:
      - 任何編輯（上月實績或預測調整）觸發儲存時，必須將 **整個 7 個月區間** (Context + 6 Months) 包裝成一個 Payload。
      - 只呼叫一次 `savePSI` API，禁止分拆多次呼叫。
- **上個月資料處理規則**:
      - **寫入 Context**: 必須產生一筆額外的資料列 (上個月)，寫入前端輸入的 `Actual P`, `Actual S` 與計算出的 `Actual I`，同時保留原始預測值。
      - **目的**: 確保後端資料庫完整記錄「實績」與「原預測」，作為下個月的預測基礎與分析比較。

## 7. 錯誤處理與狀態
- **計算錯誤**: 任何導致庫存為負數的輸入或計算，必須在前端立即顯示明確錯誤訊息，並**禁用儲存按鈕**，防止錯誤數據提交。
- **輸入驗證**: 所有輸入值必須為 ≥0 的數字，否則視為無效輸入，無法儲存。
- **狀態指示**: 在數據計算中、儲存中或存在未儲存變更時，應有清晰的UI狀態提示（如載入圖示、星號標記等）。
  - 載入中: 顯示旋轉圖示，禁用編輯功能
  - 計算中: 顯示"計算中..."提示
  - 未儲存變更: 標題旁顯示"*"符號  

---
**修訂註記**: 本技能已整合上月實績比較顯示、嚴格數值驗證（禁止負數）、圖表範圍明確化（含上月實際點）及詳細錯誤處理規則。並補充了上月實績的兩種狀態（僅有實際庫存與完整上月實績）及其編輯邏輯、首次編輯預設值與狀態切換規則。