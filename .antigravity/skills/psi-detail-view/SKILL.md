---
name: PSI 詳細預測視圖 (PSI Detail View)
description: PSI 詳細頁面 (psi_detail.html) 的顯示標準與邏輯。
---

# PSI 詳細預測視圖技能 (PSI Detail View Skill)

此技能定義了 PSI (預測到貨、預測銷售、庫存) 詳細頁面的複雜視覺風格與邏輯。

## 1. UI 結構
-   **標題區**: 左側顯示產品名稱 (H2) 與客戶名稱 (副標題)。右側顯示 "返回列表" 按鈕。
-   **初始庫存**: 提供 "期初庫存 (上月底)" 的輸入欄位。
-   **PSI 網格 (Grid)**:
    -   **佈局**: 使用 CSS Grid，若有需要可啟用水平滾動（但優先考慮讓 6 個月視圖適應螢幕）。
    -   **行項目**:
        1.  **標題行**: 月份名稱 (例如 "2026 年 1 月")。背景色：淺藍色。
        2.  **預測到貨 (P)**: 文字顏色：綠色。
        3.  **預測銷售 (S)**: 文字顏色：紅色。
        4.  **庫存預測 (I)**: 文字顏色：黑色，加粗。背景色：淺色高亮。

## 2. 互動邏輯 (點擊編輯)
-   **預設唯讀**: 主表格預設處於唯讀模式。
-   **觸發編輯**:
    -   點擊 **月份標題** 或 **任何 P/S 儲存格** 時，開啟 `<dialog id="dialog-edit-month">`。
-   **彈出視窗內容**:
    -   標題：月份名稱。
    -   輸入欄位：預測到貨 (P)、預測銷售 (S)。
    -   動作：儲存、取消。

## 3. 數據邏輯 (PSI 核心)
-   **公式**: `當月庫存 (I) = 前月庫存 + 當月預測到貨 (P) - 當月預測銷售 (S)`
-   **響應式計算**:
    -   **即時回饋**: 修改「期初庫存」或任何月份的 P/S 時，必須 **立即** 在前端 DOM 中重新計算該月份及其後所有月份的庫存 (I)。
    -   **無需等待**: 不要等待後端回應才更新 UI 數值，應先在前端完成計算並更新顯示。
-   **數據範圍**: 6 個月 (當月 + 未來 5 個月)。

## 4. 視覺化
-   **圖表**: 在網格下方使用 Canvas (Chart.js) 顯示 P、S、I 的趨勢圖。

## 5. 語言規範
-   嚴格遵守 `localization-rules` 技能。
-   標準標籤："預測到貨 (P)", "預測銷售 (S)", "庫存預測 (I)"。

## 6. 資料儲存規範 (Persistence Logic)
- **儲存範圍**: 呼叫儲存 API 時，必須同時包含 **「 6 個月預測」** 與 **「上個月實際庫存 (Context)」**。
- **上個月資料處理規則**:
      - **寫入 Context**: 必須產生一筆額外的資料列，將 UI 上的 `期初庫存 (Initial Inventory)` 寫入上的 `i_value` 欄位。該筆資料的 `p_value` 與 `s_value` 應設為 0。
    - **目的**: 確保後端資料庫能正確記錄期初庫存值，供下次 `getPSIContext` 讀取時還原狀態。
